<!-- _blueprint/knowledge/cr/CR-0043.md -->

# Change Request — [CR-0043] Full IDE (IDE-only) via ImGui Docking + Services

## Header
- **CR ID:** [CR-0043]
- **Title:** Boot-to-IDE “Full IDE” upgrade (classic panes + modern services)
- **Status:** Draft
- **Owner:** TBD
- **Created:** 2025-12-24
- **Target Release:** v0.2.0
- **Related Issues/Links:** Upgrade intake `/blueprint/upgrade_intake.md` (2025-12-24)
- **Scope Type:** Feature | Tooling

---

## 1) Summary
Deliver a **boot-to-IDE** “Full IDE” environment (IDE-only) replacing the current minimal Workbench editor with a **classic pane layout** (Files left, Editor center, Preview right, Console bottom) and modern usability:
- Docking layout + persistence (ImGui docking branch, via **DiligentTools integration**)
- Modern editor core (multi-cursor, column selection, undo tree, find/replace)
- Workspace search/replace (PCRE2, streaming + cancellable)
- tree-sitter incremental parsing for highlight/folding/outline (Squirrel grammar + query files)
- Task console + problem matchers
- Protocol services: **DAP** (runtime/Squirrel debug) + **LSP** (Squirrel-only)
- Local Timeline history (SQLite + zstd + xxHash), restore + diff
- TOML settings + keybindings (VSCode-like defaults) + layout/open-files persistence

**Non-goal confirmed:** no runtime/render/audio feature changes beyond exposing Run/Stop/Restart in the IDE Preview; any debug instrumentation must be **disabled unless debugging**.

---

## 2) Motivation
- The current Workbench provides a minimal editor UI but does not meet “Full IDE” expectations (navigation, structured editing, fast search, history, tasks, protocol-based debugging/language services).
- The requested feature set formalizes the IDE as a first-class subsystem aligned with [REQ-01] Workbench product intent, without expanding runtime features.

---

## 3) Scope

### 3.1 In Scope (v0.2.0)
New/expanded IDE capabilities (IDs reserved below):
- Dockspace + classic panes + persistence ([REQ-63], [TEST-27])
- Project navigation UX: explorer, outline, palette, breadcrumbs ([REQ-64..66])
- Editor core rewrite: TextBuffer + undo tree + multi-cursor/column selection + find/replace ([REQ-67], [TEST-28])
- Workspace search/replace via PCRE2 streaming + cancel ([REQ-68], [TEST-29])
- tree-sitter incremental parse + query-based highlight/locals/injections + folding + outline (Squirrel) ([REQ-69], [TEST-30])
- Preview pane embeds existing runtime view; Run/Stop/Restart + optional restart-on-save ([REQ-70])
- Console tabs: IDE log, task output + problem matchers, optional REPL, debug console ([REQ-71], [TEST-32])
- DAP client + **ARCANEE runtime/Squirrel DAP adapter** baseline ([REQ-72], [TEST-33])
- LSP client for **Squirrel only** ([REQ-73], [TEST-34])
- Timeline snapshots + restore + diff (SQLite + zstd + xxHash) ([REQ-74], [TEST-31])
- Settings/keybindings: layered TOML; VSCode-like defaults; conflict detection; persist layout + session ([REQ-75], [TEST-34])
- Performance: UI thread render/input only; background workers + cancellability; main-thread apply queue ([REQ-76])

### 3.2 Out of Scope (v0.2.0)
- New runtime rendering/audio/input features beyond Preview control wiring (Run/Stop/Restart) (confirmed).
- Git integration (Timeline is local, not Git).
- Non-Squirrel LSP support.
- Full terminal emulation.

---

## 4) Affected Blueprint Areas & New IDs

### 4.1 New Requirements (append-only)
- [REQ-63] Dockspace classic panes + persisted layout.
- [REQ-64] Project Explorer (tree, filters, create/rename/delete, recent).
- [REQ-65] Command Palette unified actions.
- [REQ-66] Breadcrumb bar navigation.
- [REQ-67] Editor baseline: multi-cursor, column select, undo tree, find/replace.
- [REQ-68] Workspace search/replace: PCRE2 regex, streaming, preview, cancel.
- [REQ-69] ParseService: tree-sitter incremental + queries; folding + outline (Squirrel).
- [REQ-70] Preview embeds existing runtime view; Run/Stop/Restart; optional restart-on-save.
- [REQ-71] Bottom console: log + task output (problem matchers) + optional REPL + debug console.
- [REQ-72] DAP client UI + session manager.
- [REQ-73] LSP client (Squirrel-only) with diagnostics and navigation hooks.
- [REQ-74] Timeline snapshots: auto+manual; restore+diff; SQLite+zstd+xxHash.
- [REQ-75] TOML settings (user+project) + keybinding editor + conflict detection + session persistence.
- [REQ-76] Responsiveness: background work + cancel; UI-thread-only rendering/input.

### 4.2 New Architecture
- [ARCH-11] IDE subsystem decomposition: UIShell, ProjectSystem, DocumentSystem, TextBuffer, ParseService, SearchService, TaskRunner, TimelineStore, LspClient, DapClient.

### 4.3 New API Contracts (Ch4 additions; IDs reserved)
- [API-07] UIShell (panes, palette, focus/shortcuts, main-thread apply queue).
- [API-08] ProjectSystem (workspace root `samples/<project>`, file model, ignore rules, recent).
- [API-09] DocumentSystem (open buffers, encoding/EOL, autosave/crash recovery, cursor state).
- [API-10] TextBuffer (rope/piece-table, multi-cursor ops, undo tree, snapshot for diff).
- [API-11] ParseService (incremental edit feed, query runner outputs: highlights/folds/outline).
- [API-12] SearchService (PCRE2 compile, streaming result API, cancel token).
- [API-13] TaskRunner (tasks.toml parsing, process spawn, capture, problem matcher events).
- [API-14] TimelineStore (SQLite schema, blob store, retention/exclusions, diff API).
- [API-15] LspClient (JSON-RPC transport, request routing, diagnostics + goto/refs hooks).
- [API-16] DapClient (DAP transport, session state, breakpoint/stack/vars/watch API).

### 4.4 Build / Dependencies
- [BUILD-07] Add & pin: tree-sitter + tree-sitter-squirrel, PCRE2, SQLite, zstd, xxHash, tomlplusplus, nlohmann/json, spdlog (if not already pinned), and ensure ImGui docking via DiligentTools path (no standalone ImGui source).

### 4.5 Tests (append-only)
- [TEST-27] Dockspace/layout persistence roundtrip.
- [TEST-28] TextBuffer property tests: multi-cursor + column select + undo tree invariants.
- [TEST-29] SearchService: streaming + cancel + replace preview correctness.
- [TEST-30] ParseService: incremental highlight/fold/outline stability across edits (golden fixtures).
- [TEST-31] TimelineStore: snapshot/restore/diff + dedup + retention enforcement.
- [TEST-32] TaskRunner: capture + problem matcher emits clickable diagnostics model.
- [TEST-33] DAP: end-to-end session against ARCANEE adapter (breakpoints/stack/vars/watch).
- [TEST-34] Settings/keybindings: layered TOML merge + conflict detection + defaults.

---

## 5) Key Decisions (to be added in decision_delta_log.md during v0.2.0 blueprint update)
- [DEC-27] Use ImGui docking branch via DiligentTools integration (source of truth) and enable docking + multi-viewport policy in one place.
- [DEC-28] TextBuffer structure selection (piece-table/rope) + undo tree representation; performance gates for typing latency.
- [DEC-29] Timeline storage + retention rules:
  - 15 snapshots for scripts (e.g., `.nut` and other text script types configured)
  - 3 snapshots for non-script files
  - exclude rebuildable/temporary artifacts via ignore patterns (see [DEC-32] interplay)
- [DEC-30] LSP scope: Squirrel-only; diagnostics + navigation first; other features opt-in.
- [DEC-31] DAP baseline: ARCANEE runtime/Squirrel adapter (not a mock); adapter runs as a tool or integrated service; debug instrumentation disabled unless session active.
- [DEC-32] Tasks model: `<workspace>/.arcanee/tasks.toml` minimal schema; controlled env/cwd; problem matchers configured per-task.
- [DEC-33] Introduce top-level `/cr/` directory (this file) while retaining `/blueprint/` as the blueprint source of truth.

---

## 6) Design Notes (implementation-facing)

### 6.1 Workspace & metadata
- **Workspace root:** `samples/<project>/`
- **Project metadata:** `samples/<project>/.arcanee/`
  - `settings.toml` (project settings)
  - `tasks.toml` (tasks)
  - `layout.ini` (optional: ImGui ini override if we separate per-project)
  - `timeline/` (TimelineStore data) OR platform user-data dir (final in [DEC-29])

### 6.2 Threading model
- UI thread: render/input only; no long work.
- Worker pool: parse/search/timeline/protocol I/O.
- Main-thread apply queue: immutable result packets applied deterministically (UI state + editor decorations).
- Cancel tokens everywhere ([REQ-76]).

### 6.3 Text model & diff
- TextBuffer provides:
  - stable positions via piece/rope anchors
  - undo tree nodes (branchable)
  - snapshot view for Timeline diff
- Diff shown in IDE (line-based) for restore preview.

### 6.4 Protocols
- JSON: nlohmann/json used for JSON-RPC + DAP framing/parsing.
- LSP: Squirrel-only server discovery/config via TOML; lifecycle managed by LspClient.
- DAP: ARCANEE adapter provides at minimum the flows needed by [TEST-33]:
  - initialize/launch/attach (as applicable)
  - setBreakpoints
  - stackTrace/scopes/variables
  - continue/next/stepIn/stepOut (if supported by runtime hooks)
  - evaluate (debug console)
  - output/events

---

## 7) Compatibility & Versioning
- **Target:** v0.2.0 (MINOR bump from v0.1.0)
- **API breaking?** No external SDK API is promised (per existing [DEC-04]); internal refactors are allowed.
- **Behavior changes:** Workbench UI changes significantly; this is expected and versioned by release.
- **Migration:** existing projects under `samples/` remain valid; `.arcanee/` folder is additive.

---

## 8) Acceptance Criteria (DoD for [CR-0043])
- All DoD bullets in the user spec are implemented and mapped to:
  - ≥1 [TEST-27..34] each (as applicable)
  - ≥1 checklist step in `/blueprint/implementation_checklist.yaml`
- CI gates:
  - Fail on any “[TEMP-DBG]”
  - Fail on any “N/A” without a [DEC]
  - Fail if any new [REQ-63..76] lacks ≥1 test + checklist step
- DAP works against ARCANEE adapter baseline.
- LSP supports Squirrel-only (minimum diagnostics + navigation hooks as defined in v0.2 blueprint).

---

## 9) Rollout Plan
1. Land v0.2 blueprint updates (vNEXT) + decision_delta_log + walkthrough/checklist updates.
2. Implement subsystem scaffolding + build/pin deps ([BUILD-07]).
3. Bring up dockspace + panes + persistence ([TEST-27]).
4. Replace editor core with TextBuffer + undo tree + selections ([TEST-28]).
5. Add ParseService and SearchService + cancellations ([TEST-29], [TEST-30]).
6. Add TimelineStore + diff/restore ([TEST-31]).
7. Add TaskRunner + problem matchers + console wiring ([TEST-32]).
8. Add DAP + ARCANEE adapter + debug UI ([TEST-33]).
9. Add Squirrel LSP wiring ([TEST-34]).

---

