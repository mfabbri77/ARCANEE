# Change Request — CR-0044
TOML `config/` system (Editor + ImGui Dock), unified theming, Tree-sitter TOML + Squirrel highlighting, TOML keybindings, hot-apply on IDE save.

---

## Header
- **CR ID:** [CR-0044]
- **Title:** TOML `config/` + hot-apply + unified theme + Tree-sitter TOML + TOML keybindings
- **Status:** Draft
- **Owner:** TBD
- **Created:** 2025-12-26
- **Target Release:** v0.3.0
- **Related:** Feature request “TOML-Based Configuration System…”
- **Scope Type:** Feature

---

## 1) Summary
Implement a repo-root `./config/` directory containing TOML configuration files to control:
- Editor behavior, indentation, and **system-font-only** typography
- ImGui-dock GUI metrics + UI font
- Keybindings (TOML), with deterministic conflict handling
- A unified color scheme that drives editor UI colors, syntax token colors (Tree-sitter), and ImGui style colors

All changes are **hot-applied on save** of `config/*.toml` files **when saved inside the IDE** (no filesystem watcher). Invalid config is **non-fatal**: diagnostics appear in the Problems window and invalid fields fall back to safe defaults (field-by-field).

---

## 2) Motivation / Problem
- v0.2 has TOML usage for `tasks.toml` and runtime manifest parsing, but **no implemented editor/gui settings loader** and **no implemented keybinding system** in code.
- Tree-sitter is integrated for Squirrel parsing/highlighting via a single hardcoded squirrel query file; `.toml` is not supported.
- The GUI (ImGui Dock) and editor currently do not share a single “source of truth” for theming.

This CR delivers an end-user editable configuration system without recompilation and enables rapid iteration via hot-apply.

---

## 3) Observed Implementation Reality (code, not blueprint)
(checked in repo)
- TOML parsing in `src/ide/TaskRunner.cpp` via `toml++`.
- Separate minimal TOML parsing in `src/runtime/Manifest.*` (not toml++).
- Tree-sitter integration in `src/ide/ParseService.*` for Squirrel only:
  - Uses `tree_sitter_squirrel()` and loads highlight query from `assets/ide/treesitter/squirrel/queries/highlights.scm`.
  - Capture name → hardcoded ARGB colors mapping.
- No `.arcanee/settings.toml` or `.arcanee/keybindings.toml` references in code; those paths exist only in v0.2 blueprint text.

Implication: “Replace layered settings/keybindings” is primarily a **blueprint/governance** change for v0.3; code does not currently implement the old model.

---

## 4) Requirements & Decisions (new IDs)
### 4.1 Requirements
- [REQ-90] Add repo-root `config/` with optional TOML files: `color-schemes.toml`, `editor.toml`, `gui.toml`, `keys.toml`; missing files fall back to built-in defaults.
- [REQ-91] Hot-apply on save (IDE saves only): debounce → parse → validate → apply; invalid fields fall back per-field, app remains usable.
- [REQ-92] Fonts are system-installed only: family/weight/style allowed; **no file paths**; invalid font selection falls back to last-known-good (or deterministic system fallback) with Problems diagnostics.
- [REQ-93] Unified theming: active scheme is the single source of truth for editor UI colors, syntax token colors, and ImGui style colors.
- [REQ-94] Tree-sitter highlighting for `.nut` and `.toml`, using a stable IDE-owned token set and capture→token mapping.
- [REQ-95] Add “Configuration” top-level menu:
  - “Open Config Folder” opens `./config/` in IDE explorer UI scoped to that root.
  - Optional “New Config File” creates missing config files populated with commented defaults.
- [REQ-96] Keybindings in `config/keys.toml`: multiple bindings per action, `primary` modifier abstraction, conflict detection with deterministic **last definition wins**.
- [REQ-97] Problems integration: config parse/validation issues produce structured diagnostics (file, line/col if available, severity, message, key path).
- [REQ-98] UTF-8-only TOML IO: reject invalid encoding at IO boundary; surface diagnostics; do not add an encoding option.

### 4.2 Decisions
- [DEC-62] **Replace** prior v0.2 “layered user+project settings/keybindings paths” with repo-root `./config/` model for v0.3. Old paths remain reserved but unused; blueprint text updated accordingly.
- [DEC-63] GUI theme uses **derived deterministic mapping** from `[scheme.editor]` base colors for MVP, with optional `[scheme.gui]` overrides if present.
- [DEC-64] Use `toml++` for config parsing/DOM + type-safe extraction. Validation is in-house (schema + semantic checks) to support partial fallback and unknown-key warnings.
- [DEC-65] Implement system font discovery using platform backends:
  - Windows: DirectWrite
  - macOS: CoreText
  - Linux: fontconfig
  Degrade gracefully if backend unavailable (keep last-known-good font; emit diagnostics).
- [DEC-66] “Open Config Folder” is implemented as an **explorer root mode** (Project vs Config), without replacing the active project root.
- [DEC-67] Config location: **primary** `./config/` relative to process working directory. If missing, attempt `exe_dir/config` as a compatibility fallback (diagnostic emitted if fallback path used).

### 4.3 Architecture / API
- [ARCH-12] Config hot-reload pipeline: save-event → debounce → parse/validate off-thread → main-thread apply (atomic snapshot swap).
- [API-17] Internal `ConfigSnapshot` contract + per-subsystem `ApplyConfig(const ConfigSnapshot&)` (Theme/Fonts/Keymap/GuiMetrics) with last-known-good rollback.

---

## 5) Proposed Solution Design
### 5.1 Config Files (repo root)
- `config/color-schemes.toml` (SHIPPED by default; user-modifiable)
- `config/editor.toml` (optional)
- `config/gui.toml` (optional)
- `config/keys.toml` (optional)

Precedence:
1) Built-in defaults (hardcoded)
2) `./config/*.toml` (if present/valid per-field)
3) Future: CLI/env overrides (non-MVP)

### 5.2 Schema + Validation (non-fatal)
- Unknown keys → Warning diagnostic, ignored.
- Invalid values/type mismatch → Warning diagnostic, field falls back to default.
- Missing references (e.g., scheme id) → Warning diagnostic, fallback scheme selected.
- Parse errors → Error diagnostic, file ignored; last-known-good snapshot kept.

Diagnostics include `key_path` (e.g., `font.size_px`, `color_scheme.active`) and best-effort `line/column`:
- Use `toml::parse_error` source region when available.
- If region not available for a semantic validation issue, attach at file-level (`line=1,col=1`) and include key_path.

### 5.3 Hot-apply trigger (IDE only)
- Modify `DocumentSystem::SaveDocument` to notify listeners (`OnSaved(path)`).
- Config system registers a listener and triggers reload only for paths under `config/` and matching `*.toml`.
- Debounce window (e.g., 150–250ms) in UI loop to coalesce multi-save events.

### 5.4 Unified theming
- One active scheme id in `editor.toml` (`[color_scheme] active = "<id>"`).
- Apply to:
  - Editor UI colors
  - Syntax token palette (IDE token set)
  - ImGui `ImGuiStyle::Colors[]` via derived mapping (MVP) + optional explicit overrides

### 5.5 Tree-sitter TOML + Squirrel highlighting
- Extend ParseService to support multiple languages based on file extension:
  - `.nut` → tree-sitter-squirrel + squirrel highlight queries
  - `.toml` → tree-sitter-toml + toml highlight queries
- Introduce stable mapping layer:
  - capture name (e.g., `keyword`, `string`, `comment`) → IDE token enum (`Token::Keyword`, …)
  - token enum → scheme.syntax color key (`keyword`, …)
- Unknown capture: use scheme.editor.foreground (optionally dimmed).

### 5.6 Keybindings
- Define stable action IDs (seeded from v0.2; extend as needed for v0.3):
  - e.g., `file.save`, `file.open`, `command_palette.open`, `editor.copy`, `editor.paste`, `editor.find`, `view.toggle_sidebar`, …
- Parse `config/keys.toml`:
  - `[keys] "action.id" = ["primary+S", "Ctrl+Shift+P"]`
- Normalize into platform key chords:
  - `primary` → Ctrl (Win/Linux), Cmd (macOS)
- Conflict resolution:
  - last definition wins
  - warning diagnostic for overwritten chords and overwritten actions

### 5.7 “Configuration” menu
Add a top-level menu:
- Configuration → Open Config Folder
  - Ensure `./config` exists (create if missing)
  - Switch explorer root mode to Config
- Configuration → New Config File (optional)
  - Create missing `editor.toml`, `gui.toml`, `keys.toml` (and optionally re-generate `color-schemes.toml` if missing) populated with commented defaults.

---

## 6) Implementation Plan (Files / Modules)
### 6.1 New / Updated Modules (expected)
- **New:** `src/ide/config/ConfigSystem.{h,cpp}`
  - load/merge defaults + TOML files
  - validation + diagnostics emission
  - debounce + apply scheduling
- **New:** `src/ide/config/ConfigSchema.{h,cpp}`
  - strongly-typed structs: `EditorConfig`, `GuiConfig`, `KeysConfig`, `ColorSchemes`
- **New:** `src/ide/config/ThemeSystem.{h,cpp}`
  - scheme registry + derived ImGui mapping
  - editor palette + syntax palette output
- **New:** `src/ide/config/Keymap.{h,cpp}`
  - parse chords + platform normalization + action registry
- **New:** `src/platform/FontLocator_{win,mac,linux}.{h,cpp}`
  - `FontSpec{family,size_px,weight,style}`
  - locate best match + load into ImGui/editor font systems
- **Update:** `src/ide/DocumentSystem.{h,cpp}`
  - add save listeners hook
- **Update:** `src/ide/UIShell.{h,cpp}`
  - add Configuration menu + open config folder mode
  - integrate config diagnostics into Problems pane
  - apply theme/font/keymap on snapshot changes
- **Update:** `src/ide/ParseService.{h,cpp}`
  - multi-language support + token mapping + theme-driven colors
- **Assets:** add `assets/ide/treesitter/toml/queries/highlights.scm`

### 6.2 Build / Dependencies
- Add FetchContent for **tree-sitter TOML grammar** (pinned tag/commit) and compile `src/parser.c` (+ `scanner.c` if present) into `tree-sitter-toml` static lib.
  - Prefer `https://github.com/tree-sitter-grammars/tree-sitter-toml`
- Platform font dependencies:
  - Windows: link `dwrite`, `d2d1` as needed
  - macOS: link CoreText/CoreFoundation
  - Linux: find/link `fontconfig` (system package; optional soft dependency with fallback)

---

## 7) Tests & Quality Gates
### 7.1 New Tests
- [TEST-39] Config parsing/validation/fallback:
  - unknown keys warn
  - invalid values fallback per-field
  - parse errors do not crash; last-known-good retained
- [TEST-40] Unified theming:
  - switch scheme id → updates editor palette + syntax palette + ImGui derived colors deterministically
- [TEST-41] Keybindings determinism:
  - conflicts produce warnings
  - last definition wins
  - `primary` expands correctly per platform
- [TEST-42] Fonts system-only enforcement:
  - font path keys ignored + diagnostic
  - missing family falls back to deterministic system fallback; if backend fails, keep last-known-good

### 7.2 CI / Tooling gates (existing)
- No `[TEMP-DBG]` permitted.
- No `N/A` without `[DEC-XX]`.
- Every new [REQ-90..98] has ≥1 test and ≥1 checklist step.

---

## 8) Compatibility & Versioning
- **API breaking?** No (internal IDE feature)
- **ABI breaking?** No (no stable ABI surface)
- **Behavior changes:**
  - Settings/keybindings paths from v0.2 blueprint are deprecated/replaced (no code migration needed since not implemented).
- **Release:** v0.3.0 (MINOR bump)

---

## 9) Risks / Mitigations
- Font backend variance across platforms → keep last-known-good on failure; provide diagnostics; ensure build uses optional linkage where feasible.
- Theme mapping correctness → deterministic mapping + golden tests (serialize ImGui colors + compare).
- Performance: hot-apply of fonts/theme → debounce + main-thread apply; avoid realloc storms.

---

## 10) Acceptance Criteria Trace
This CR satisfies:
- [REQ-90..98] and acceptance points 1–10 of the feature request, with explicit non-fatal diagnostics and immediate apply-on-save (IDE saves only).

